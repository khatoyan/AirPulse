import React, { useState } from 'react';
import {
  Box,
  Typography,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Divider,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Link,
  Paper,
  Grid,
  TextField,
  InputAdornment,
  IconButton,
  useTheme,
  Button,
  Alert
} from '@mui/material';
import {
  ExpandMore as ExpandMoreIcon,
  Search as SearchIcon,
  Link as LinkIcon,
  QuestionAnswer as QuestionIcon,
  LocalHospital as HospitalIcon,
  Book as BookIcon,
  Clear as ClearIcon,
  ArrowRight as ArrowRightIcon
} from '@mui/icons-material';

function FAQTab() {
  const theme = useTheme();
  const [expanded, setExpanded] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [emailSubscribe, setEmailSubscribe] = useState('');
  const [subscribeSubmitted, setSubscribeSubmitted] = useState(false);

  const handleChange = (panel) => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false);
  };

  const handleSearchChange = (event) => {
    setSearchQuery(event.target.value);
  };

  const handleClearSearch = () => {
    setSearchQuery('');
  };

  const handleEmailChange = (event) => {
    setEmailSubscribe(event.target.value);
  };

  const handleSubscribe = () => {
    // Здесь будет логика отправки email на сервер
    setSubscribeSubmitted(true);
    setTimeout(() => {
      setSubscribeSubmitted(false);
      setEmailSubscribe('');
    }, 3000);
  };

  const categories = [
    { id: 'general', title: 'Общие вопросы' },
    { id: 'symptoms', title: 'Симптомы и диагностика' },
    { id: 'treatment', title: 'Лечение и профилактика' },
    { id: 'children', title: 'Аллергия у детей' },
    { id: 'app', title: 'О нашем приложении' }
  ];

  const faqs = [
    // Общие вопросы
    {
      category: 'general',
      question: 'Что такое аллергия и почему она возникает?',
      answer: 'Аллергия — это повышенная чувствительность иммунной системы к определенным веществам (аллергенам), которые обычно безвредны. При контакте с аллергеном иммунная система воспринимает его как угрозу и вырабатывает антитела, что приводит к воспалительной реакции, вызывающей различные симптомы. Причины возникновения аллергии могут быть как генетическими, так и связанными с факторами окружающей среды.'
    },
    {
      category: 'general',
      question: 'Какие бывают виды аллергенов?',
      answer: 'Основные виды аллергенов включают: пыльцу растений, пылевых клещей, перхоть и шерсть животных, плесневые грибки, некоторые продукты питания (орехи, молоко, яйца, морепродукты), укусы насекомых, лекарственные препараты и химические вещества. Каждый из этих аллергенов может вызывать различные реакции у разных людей.'
    },
    {
      category: 'general',
      question: 'Является ли аллергия наследственным заболеванием?',
      answer: 'Да, существует генетическая предрасположенность к аллергическим реакциям. Если один из родителей страдает аллергией, вероятность ее развития у ребенка составляет около 25-30%. Если аллергия есть у обоих родителей, вероятность увеличивается до 50-70%. Однако наследуется не конкретная аллергия, а предрасположенность к аллергическим реакциям в целом.'
    },
    {
      category: 'general',
      question: 'Что такое перекрестная аллергия?',
      answer: 'Перекрестная аллергия возникает, когда человек с аллергией на определенное вещество реагирует также на другие вещества со схожей структурой белков. Например, люди с аллергией на пыльцу березы могут реагировать на яблоки, морковь или орехи. Это происходит потому, что иммунная система воспринимает белки в этих продуктах как идентичные или очень похожие на белки аллергена.'
    },
    {
      category: 'general',
      question: 'Может ли аллергия возникнуть в любом возрасте?',
      answer: 'Да, аллергия может развиться в любом возрасте, даже у людей, которые ранее не имели аллергических реакций. У детей аллергии обычно проявляются раньше, но взрослые также могут внезапно начать реагировать на вещества, с которыми контактировали годами без проблем. Это может быть связано с изменениями в иммунной системе, окружающей среде или кумулятивным эффектом воздействия аллергена.'
    },

    // Симптомы и диагностика
    {
      category: 'symptoms',
      question: 'Каковы основные симптомы аллергии?',
      answer: 'Основные симптомы аллергии включают насморк, чихание, зуд и покраснение глаз, кожные высыпания или зуд, отек губ или языка, затрудненное дыхание, кашель, хрипы, а в тяжелых случаях - анафилактический шок. Симптомы могут варьироваться в зависимости от типа аллергена и индивидуальной реакции организма.'
    },
    {
      category: 'symptoms',
      question: 'Как отличить аллергию от простуды?',
      answer: 'В отличие от простуды, аллергия обычно не сопровождается повышением температуры тела, ознобом и мышечными болями. Симптомы аллергии могут длиться гораздо дольше (недели или месяцы), особенно если контакт с аллергеном продолжается. Выделения из носа при аллергии обычно прозрачные и водянистые, в отличие от густых, желтых или зеленых выделений при инфекции. Также аллергия часто сопровождается зудом глаз, носа, горла или кожи.'
    },
    {
      category: 'symptoms',
      question: 'Какие существуют методы диагностики аллергии?',
      answer: 'Основные методы диагностики включают: кожные пробы (прик-тесты), при которых небольшое количество аллергена вводится под кожу; анализ крови на специфические антитела (IgE); элиминационную диету для выявления пищевой аллергии; провокационные тесты под наблюдением врача. Комплексная диагностика обычно включает сбор медицинской истории, физическое обследование и специальные тесты.'
    },
    {
      category: 'symptoms',
      question: 'Что такое анафилаксия и как ее распознать?',
      answer: 'Анафилаксия — это тяжелая, потенциально опасная для жизни аллергическая реакция, которая развивается быстро и может привести к летальному исходу без экстренной помощи. Симптомы включают: отек горла и затрудненное дыхание, хрипы, сильное головокружение или обморок, учащенное сердцебиение, резкое падение артериального давления, тошноту и рвоту, обширную кожную сыпь или отек. При появлении этих симптомов необходимо немедленно вызвать скорую помощь.'
    },
    {
      category: 'symptoms',
      question: 'Как связаны аллергия и астма?',
      answer: 'Аллергия и астма часто связаны, и у многих людей с астмой есть аллергическая астма. Это означает, что их симптомы астмы вызываются аллергенами. Контакт с аллергенами может вызвать воспаление дыхательных путей, что приводит к симптомам астмы, таким как кашель, свистящее дыхание и одышка. Исследования показывают, что до 80% людей с астмой имеют аллергию, и контроль аллергии часто помогает контролировать астму.'
    },

    // Лечение и профилактика
    {
      category: 'treatment',
      question: 'Какие существуют медикаменты для лечения аллергии?',
      answer: 'Основные типы лекарств для лечения аллергии включают: антигистаминные препараты (блокируют действие гистамина, вызывающего симптомы); кортикостероидные назальные спреи и кремы (уменьшают воспаление); противоаллергические глазные капли; деконгестанты (снимают заложенность носа); антилейкотриеновые препараты (для лечения астмы и аллергии); адреналин (для экстренного лечения анафилаксии). Лечение следует проводить только по назначению врача.'
    },
    {
      category: 'treatment',
      question: 'Что такое аллерген-специфическая иммунотерапия?',
      answer: 'Аллерген-специфическая иммунотерапия (АСИТ) — это метод лечения, при котором пациенту вводят постепенно возрастающие дозы аллергена для изменения иммунного ответа организма. Цель — снизить чувствительность к аллергену и уменьшить симптомы при естественном контакте с ним. АСИТ может проводиться в виде подкожных инъекций или сублингвальных (подъязычных) таблеток или капель. Курс лечения обычно длится 3-5 лет и может обеспечить долгосрочное облегчение даже после окончания терапии.'
    },
    {
      category: 'treatment',
      question: 'Можно ли вылечить аллергию навсегда?',
      answer: 'Полностью вылечить аллергию сложно, но можно добиться длительной ремиссии и существенного снижения симптомов. Наиболее эффективным методом является аллерген-специфическая иммунотерапия, которая может привести к долгосрочному улучшению. У детей некоторые виды аллергии, например, пищевая, могут пройти с возрастом. Тем не менее, для большинства взрослых аллергия остается хроническим состоянием, требующим постоянного управления.'
    },
    {
      category: 'treatment',
      question: 'Какие существуют народные средства для облегчения симптомов аллергии?',
      answer: 'Некоторые народные средства могут помочь облегчить симптомы аллергии: промывание носа солевым раствором для очищения от аллергенов; употребление меда местного производства (может помочь при пыльцевой аллергии, хотя научные доказательства противоречивы); травяные чаи с ромашкой, мятой или крапивой, обладающие противовоспалительным действием. Важно помнить, что народные средства не заменяют медицинское лечение и перед их использованием стоит проконсультироваться с врачом.'
    },
    {
      category: 'treatment',
      question: 'Как предотвратить обострение сезонной аллергии?',
      answer: 'Для предотвращения обострения сезонной аллергии рекомендуется: следить за прогнозом концентрации пыльцы и ограничивать пребывание на улице в дни с высоким содержанием аллергенов; держать окна закрытыми в период пыления; использовать очистители воздуха в помещении; принимать душ и менять одежду после возвращения с улицы; начинать прием антигистаминных препаратов до начала сезона аллергии (по назначению врача); использовать солнцезащитные очки для защиты глаз.'
    },

    // Аллергия у детей
    {
      category: 'children',
      question: 'С какого возраста может проявиться аллергия у детей?',
      answer: 'Аллергия у детей может проявиться с первых месяцев жизни. Пищевая аллергия часто возникает в младенчестве, когда ребенок впервые знакомится с новыми продуктами. Атопический дерматит обычно проявляется на первом году жизни. Респираторные аллергии, такие как аллергический ринит или астма, чаще развиваются у детей старше 2-3 лет. Важно отметить, что проявления аллергии могут меняться с возрастом — это называется "аллергическим маршем".'
    },
    {
      category: 'children',
      question: 'Как определить аллергию у маленького ребенка?',
      answer: 'У маленьких детей аллергия может проявляться следующими симптомами: кожные высыпания, экзема, особенно на щеках, руках и ногах; проблемы с ЖКТ (колики, рвота, диарея); затрудненное дыхание, хрипы, частые респираторные инфекции; беспокойство, нарушения сна. Для диагностики аллергии у детей используются кожные пробы (обычно не ранее 6-12 месяцев), анализы крови на специфические IgE, элиминационные диеты. Важно обратиться к педиатру или детскому аллергологу при подозрении на аллергию.'
    },
    {
      category: 'children',
      question: 'Может ли ребенок перерасти пищевую аллергию?',
      answer: 'Многие дети действительно перерастают пищевую аллергию. Примерно 80-90% детей перерастают аллергию на молоко, яйца, сою и пшеницу к школьному возрасту. Аллергия на орехи, рыбу и морепродукты обычно сохраняется дольше, иногда на всю жизнь. Шансы перерасти аллергию зависят от типа пищевого аллергена, тяжести реакции и уровня специфических IgE-антител. Регулярные консультации с аллергологом помогут оценить, когда можно безопасно повторно ввести продукт в рацион.'
    },
    {
      category: 'children',
      question: 'Как предотвратить развитие аллергии у детей из группы риска?',
      answer: 'Для предотвращения развития аллергии у детей с высоким риском (с семейной историей аллергии) рекомендуется: исключительно грудное вскармливание до 4-6 месяцев; отсутствие необходимости в чрезмерно строгой гипоаллергенной диете у матери при грудном вскармливании; своевременное введение прикорма, включая потенциально аллергенные продукты (под наблюдением); минимизация воздействия табачного дыма; контроль уровня домашних аллергенов (пылевые клещи, плесень); поддержание здоровой микробиоты кишечника. Современные рекомендации не поддерживают отсрочку введения аллергенных продуктов, так как это может увеличить риск аллергии.'
    },
    {
      category: 'children',
      question: 'Какие лекарства от аллергии безопасны для детей?',
      answer: 'Безопасность лекарств от аллергии для детей зависит от возраста ребенка и конкретного препарата. Современные антигистаминные препараты второго поколения (цетиризин, лоратадин, дезлоратадин) обычно считаются безопасными для детей старше определенного возраста (указанного в инструкции). Назальные стероидные спреи и глазные капли могут быть назначены детям при необходимости. Крайне важно использовать только препараты, одобренные для соответствующей возрастной группы, и строго следовать дозировке, назначенной врачом. Самолечение аллергии у детей недопустимо.'
    },

    // О нашем приложении
    {
      category: 'app',
      question: 'Как пользоваться картой аллергенов в приложении?',
      answer: 'Карта аллергенов в нашем приложении позволяет отслеживать концентрацию различных аллергенов в воздухе в режиме реального времени. Для использования карты откройте главную страницу приложения и нажмите на вкладку "Карта". Вы можете выбрать тип аллергена (пыльца деревьев, трав, сорняков, плесень) из выпадающего меню. Цветовая кодировка на карте показывает уровень концентрации: зеленый - низкий, желтый - средний, оранжевый - высокий, красный - очень высокий. Вы также можете настроить уведомления о высоком уровне аллергенов в вашем регионе.'
    },
    {
      category: 'app',
      question: 'Какую информацию можно получить из прогноза погоды?',
      answer: 'Наш прогноз погоды предоставляет не только стандартную информацию о температуре, влажности и осадках, но и данные, особенно важные для людей с аллергией и астмой. Вы можете получить информацию о: концентрации пыльцы различных растений; уровне загрязнения воздуха; индексе УФ-излучения; атмосферном давлении; скорости и направлении ветра. Все эти факторы могут влиять на самочувствие людей с респираторными проблемами. Прогноз обновляется ежечасно и доступен на 7 дней вперед.'
    },
    {
      category: 'app',
      question: 'Откуда берутся данные о концентрации аллергенов?',
      answer: 'Данные о концентрации аллергенов в нашем приложении собираются из нескольких источников: сеть наземных станций мониторинга, расположенных в различных регионах; спутниковые данные об атмосферных условиях и вегетации; математические модели распространения пыльцы, учитывающие погодные условия, цветение растений и географические особенности; международные и национальные базы данных по аэробиологии. Наши алгоритмы обрабатывают эти данные и предоставляют максимально точную информацию для вашего местоположения.'
    },
    {
      category: 'app',
      question: 'Можно ли вести дневник симптомов в приложении?',
      answer: 'Да, в нашем приложении есть функция дневника симптомов. Вы можете ежедневно отмечать свои симптомы (насморк, чихание, кашель, зуд глаз и т.д.), их интенсивность, принимаемые лекарства и их эффективность. Приложение сопоставляет эти данные с уровнем аллергенов и погодными условиями, помогая выявить ваши индивидуальные триггеры. Для доступа к дневнику нажмите на иконку "Дневник" в нижнем меню. Вы также можете настроить ежедневные напоминания и генерировать отчеты для вашего врача.'
    },
    {
      category: 'app',
      question: 'Как настроить уведомления об уровне аллергенов?',
      answer: 'Для настройки уведомлений об уровне аллергенов перейдите в раздел "Профиль" и выберите "Настройки уведомлений". Здесь вы можете выбрать типы аллергенов, которые вас интересуют (пыльца различных растений, плесень, пылевые клещи), пороговые значения (при каком уровне концентрации вы хотите получать уведомления), время и частоту уведомлений. Также вы можете настроить уведомления о резких изменениях погодных условий, которые могут влиять на симптомы аллергии и астмы.'
    }
  ];

  const filteredFaqs = searchQuery
    ? faqs.filter(faq => 
        faq.question.toLowerCase().includes(searchQuery.toLowerCase()) || 
        faq.answer.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : faqs;

  const resources = [
    {
      title: 'Всемирная организация аллергии',
      url: 'https://www.worldallergy.org',
      description: 'Международная организация, объединяющая специалистов в области аллергологии и клинической иммунологии со всего мира'
    },
    {
      title: 'Российская ассоциация аллергологов и клинических иммунологов',
      url: 'https://raaci.ru',
      description: 'Профессиональное сообщество врачей-аллергологов и иммунологов России'
    },
    {
      title: 'Европейская академия аллергии и клинической иммунологии',
      url: 'https://www.eaaci.org',
      description: 'Ведущая европейская организация в области аллергологии и иммунологии'
    },
    {
      title: 'Астма.ру',
      url: 'https://www.astma.ru',
      description: 'Российский портал, посвященный бронхиальной астме и аллергическим заболеваниям'
    },
    {
      title: 'Аллергологический центр',
      url: 'https://www.allergocentre.ru',
      description: 'Информационный ресурс о диагностике и лечении аллергических заболеваний'
    }
  ];

  return (
    <Box sx={{ py: 1 }}>
      <Typography variant="h5" gutterBottom color="primary" fontWeight="bold">
        Частые вопросы
      </Typography>

      <Typography paragraph sx={{ fontSize: '1.05rem', lineHeight: 1.6 }}>
        В этом разделе вы найдете ответы на часто задаваемые вопросы об аллергии, астме и
        использовании нашего приложения. Если у вас остались вопросы, не стесняйтесь обращаться к нам.
      </Typography>

      {/* Поиск */}
      <Paper 
        elevation={2} 
        sx={{ 
          p: 2, 
          mb: 4, 
          display: 'flex', 
          alignItems: 'center',
          borderRadius: 2
        }}
      >
        <TextField
          fullWidth
          variant="outlined"
          placeholder="Поиск по вопросам..."
          value={searchQuery}
          onChange={handleSearchChange}
          InputProps={{
            startAdornment: (
              <InputAdornment position="start">
                <SearchIcon color="primary" />
              </InputAdornment>
            ),
            endAdornment: searchQuery && (
              <InputAdornment position="end">
                <IconButton size="small" onClick={handleClearSearch}>
                  <ClearIcon />
                </IconButton>
              </InputAdornment>
            )
          }}
          sx={{ bgcolor: 'background.paper' }}
        />
      </Paper>

      {/* Результаты поиска */}
      {searchQuery && (
        <Box sx={{ mb: 4 }}>
          <Typography variant="h6" gutterBottom>
            Результаты поиска ({filteredFaqs.length})
          </Typography>
          {filteredFaqs.length === 0 ? (
            <Typography color="text.secondary">
              Ничего не найдено. Попробуйте изменить запрос.
            </Typography>
          ) : (
            filteredFaqs.map((faq, index) => (
              <Accordion 
                key={index}
                expanded={expanded === `search-panel-${index}`}
                onChange={handleChange(`search-panel-${index}`)}
                sx={{ mb: 1, borderRadius: 1, '&:before': { display: 'none' } }}
              >
                <AccordionSummary
                  expandIcon={<ExpandMoreIcon />}
                  aria-controls={`search-panel-${index}-content`}
                  id={`search-panel-${index}-header`}
                >
                  <Typography sx={{ fontWeight: 'medium' }}>
                    <QuestionIcon color="primary" fontSize="small" sx={{ mr: 1, verticalAlign: 'middle' }} />
                    {faq.question}
                  </Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <Typography paragraph>{faq.answer}</Typography>
                </AccordionDetails>
              </Accordion>
            ))
          )}
          <Divider sx={{ my: 3 }} />
        </Box>
      )}

      {/* Категории вопросов */}
      {!searchQuery && categories.map((category) => (
        <Box key={category.id} sx={{ mb: 4 }}>
          <Typography variant="h6" gutterBottom color="primary">
            {category.title}
          </Typography>
          {faqs.filter(faq => faq.category === category.id).map((faq, index) => (
            <Accordion 
              key={index}
              expanded={expanded === `${category.id}-panel-${index}`}
              onChange={handleChange(`${category.id}-panel-${index}`)}
              sx={{ mb: 1, borderRadius: 1, '&:before': { display: 'none' } }}
            >
              <AccordionSummary
                expandIcon={<ExpandMoreIcon />}
                aria-controls={`${category.id}-panel-${index}-content`}
                id={`${category.id}-panel-${index}-header`}
              >
                <Typography sx={{ fontWeight: 'medium' }}>
                  {faq.question}
                </Typography>
              </AccordionSummary>
              <AccordionDetails>
                <Typography paragraph>{faq.answer}</Typography>
              </AccordionDetails>
            </Accordion>
          ))}
          <Divider sx={{ my: 3 }} />
        </Box>
      ))}

      {/* Полезные ресурсы */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h6" gutterBottom color="primary" sx={{ display: 'flex', alignItems: 'center' }}>
          <BookIcon sx={{ mr: 1 }} /> Полезные ресурсы
        </Typography>
        <Grid container spacing={2}>
          {resources.map((resource, index) => (
            <Grid item xs={12} sm={6} key={index}>
              <Paper elevation={2} sx={{ p: 2, height: '100%', borderRadius: 2 }}>
                <Typography variant="subtitle1" gutterBottom sx={{ display: 'flex', alignItems: 'flex-start' }}>
                  <LinkIcon color="primary" fontSize="small" sx={{ mr: 1, mt: 0.3 }} />
                  <Link href={resource.url} target="_blank" rel="noopener noreferrer">
                    {resource.title}
                  </Link>
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  {resource.description}
                </Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>
      </Box>

      {/* Медицинские центры */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h6" gutterBottom color="primary" sx={{ display: 'flex', alignItems: 'center' }}>
          <HospitalIcon sx={{ mr: 1 }} /> Аллергологические центры
        </Typography>
        <Typography paragraph>
          Для получения профессиональной медицинской помощи рекомендуем обратиться в специализированные аллергологические центры. 
          Там вы сможете пройти диагностику и получить индивидуальные рекомендации по лечению.
        </Typography>
        <List>
          <ListItem>
            <ListItemIcon>
              <ArrowRightIcon color="primary" />
            </ListItemIcon>
            <ListItemText
              primary="Институт иммунологии ФМБА России"
              secondary="Москва, ул. Каширское шоссе, 24. Тел: +7 (499) 618-24-00"
            />
          </ListItem>
          <ListItem>
            <ListItemIcon>
              <ArrowRightIcon color="primary" />
            </ListItemIcon>
            <ListItemText
              primary="Научно-исследовательский институт пульмонологии"
              secondary="Москва, ул. 11-я Парковая, 32к4. Тел: +7 (495) 465-53-84"
            />
          </ListItem>
          <ListItem>
            <ListItemIcon>
              <ArrowRightIcon color="primary" />
            </ListItemIcon>
            <ListItemText
              primary="Центр аллергологии и иммунологии"
              secondary="Санкт-Петербург, Московский пр., 22. Тел: +7 (812) 635-55-55"
            />
          </ListItem>
        </List>
      </Box>

      {/* Подписка на обновления */}
      <Paper 
        elevation={3} 
        sx={{ 
          p: 3, 
          borderRadius: 2, 
          bgcolor: theme.palette.primary.light,
          color: '#fff'
        }}
      >
        <Typography variant="h6" gutterBottom>
          Получайте обновления по теме аллергии и астмы
        </Typography>
        <Typography paragraph>
          Подпишитесь на нашу рассылку, чтобы получать актуальную информацию о профилактике и лечении 
          аллергических заболеваний, новых методах диагностики и сезонных рекомендациях.
        </Typography>

        {subscribeSubmitted ? (
          <Alert severity="success" sx={{ mt: 2, bgcolor: 'rgba(255,255,255,0.9)', color: 'text.primary' }}>
            Спасибо за подписку! Мы отправили подтверждение на ваш email.
          </Alert>
        ) : (
          <Box sx={{ display: 'flex', mt: 2 }}>
            <TextField
              fullWidth
              variant="outlined"
              placeholder="Ваш email адрес"
              value={emailSubscribe}
              onChange={handleEmailChange}
              sx={{ 
                bgcolor: 'background.paper',
                borderTopRightRadius: 0,
                borderBottomRightRadius: 0,
                '& .MuiOutlinedInput-root': {
                  borderTopRightRadius: 0,
                  borderBottomRightRadius: 0,
                }
              }}
            />
            <Button 
              variant="contained" 
              color="secondary"
              onClick={handleSubscribe}
              disabled={!emailSubscribe.includes('@')}
              sx={{ 
                borderTopLeftRadius: 0,
                borderBottomLeftRadius: 0,
                px: 3
              }}
            >
              Подписаться
            </Button>
          </Box>
        )}
      </Paper>
    </Box>
  );
}

export default FAQTab; 